<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <title>NeuGenes Platform</title>
  <style>
    :root {
      --bg-primary: #fafafa;
      --bg-section: #ffffff;
      --light-pink: #fffafd;
      --border-soft: #fae6f2;
      --border-accent: #d4a5c9;
      --text-primary: #075058;
      --text-secondary: #5a6f72;
      --accent-teal: #0a5f5f;
      --accent-teal-light: #e6f4f4;
      --accent-coral: #b94920;
      --orange: #e97435;
      --accent-coral-light: #ffeee8;
      --accent-success: #44b830;
      --lime: #dfec57;
      --accent-success-light: #e8f5ef;
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--light-pink);
      font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem 3rem 4rem;
    }

    /* Header */
    .page-header {
      text-align: center;
      margin-bottom: 3rem;
      padding-bottom: 0rem;
    }

    .page-header h1 {
      font-size: 2rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--accent-teal);
      margin-bottom: 0.5rem;
    }


    /* Two Column Layout */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2.5rem;
      margin-bottom: 3rem;
    }

    /* Section Styling */
    .section {
      background: var(--bg-section);
      padding: 1.75rem;
      border: 4px solid var(--border-soft);
    }

    .section h2 {
      font-size: 1.5rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-primary);
      margin-bottom: 1.25rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--border-accent);
    }

    /* Drop Zone */
    .drop-zone {
      border: 2px dashed var(--border-accent);
      border-radius: var(--radius-md);
      padding: 3rem 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: linear-gradient(135deg, #fdf8fc 0%, #f8fafa 100%);
    }

    .drop-zone:hover {
      border-color: var(--accent-teal);
      background: var(--accent-teal-light);
    }

    .drop-zone.drag-over {
      border-color: var(--accent-success);
      background: var(--accent-success-light);
      transform: scale(1.01);
    }

    .drop-zone-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 1rem;
      opacity: 0.6;
    }

    .drop-zone p {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .drop-zone strong {
      color: var(--accent-teal);
    }

    /* File List */
    .file-list {
      margin-top: 1.25rem;
    }

    .file-list h3 {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
    }

    .file-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.6rem 0.9rem;
      background: #f8f6f7;
      border-radius: var(--radius-sm);
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
    }

    .file-item span {
      color: var(--text-primary);
    }

    .remove-btn {
      background: var(--accent-coral);
      color: white;
      border: none;
      padding: 0.3rem 0.7rem;
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .remove-btn:hover {
      background: #c94d30;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.7rem 1rem;
      font-family: inherit;
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      border-radius: var(--radius-sm);
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary {
      margin-top: 2rem;
      background: var(--accent-teal-light);
      color: var(--accent-teal);
      border-color: var(--accent-teal);
    }

    .btn-primary:hover {
      background: var(--lime);
    }

    .btn-primary:disabled {
      background: #ccc;
      border-color: #ccc;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--accent-teal-light);
      color: var(--accent-teal);
      border-color: var(--accent-teal);
    }

    .btn-secondary:hover {
      background: var(--lime);
    }

    .btn-accent {
      background: var(--accent-coral);
      color: white;
      border-color: var(--accent-coral);
    }

    .btn-accent:hover {
      background: #c94d30;
      border-color: #c94d30;
    }

    .btn-large {
      padding: 1rem 1.5rem;
      font-size: 0.95rem;
    }

    /* Parameters Grid */
    .params-grid {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .param-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      align-items: start;
    }

    .param-item {
      display: flex;
      flex-direction: column;
      gap: 0rem;
    }

    .param-item label {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--text-primary);

    }

    .param-item .param-desc {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .param-item input[type="text"],
    .param-item input[type="number"] {
      padding: 0.55rem 0.75rem;
      border: 1px solid var(--border-soft);
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: 0.85rem;
      transition: border-color 0.2s;
    }

    .param-item input:focus {
      outline: none;
      border-color: var(--accent-teal);
    }

    .param-item.full-width {
      grid-column: 1 / -1;
    }

    /* Radio Options */
    .radio-group {
      display: flex;
      gap: 1.5rem;
      margin-top: 0.25rem;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      cursor: pointer;
    }

    .radio-option input[type="radio"] {
      width: 16px;
      height: 16px;
      accent-color: var(--accent-teal);
    }

    .radio-option span {
      font-size: 0.85rem;
      color: var(--text-primary);
    }

    /* Brain Structure Tree */
    .tree-container {
      max-height: 350px;
      overflow-y: auto;
      padding: 0.75rem;
    }

    #brainStructureTree ul {
      list-style: none;
      padding-left: 1.25rem;
    }

    #brainStructureTree>ul {
      padding-left: 0;
    }

    #brainStructureTree li {
      margin: 0.3rem 0;
    }

    #brainStructureTree input[type="checkbox"] {
      margin-right: 0.4rem;
      accent-color: var(--accent-teal);
    }

    #brainStructureTree .toggle {
      font-size: 0.85rem;
      cursor: pointer;
      padding: 0.15rem 0.4rem;
      border-radius: 3px;
      transition: background 0.15s;
    }

    #brainStructureTree .toggle:hover {
      background: var(--accent-teal-light);
    }

    #brainStructureTree .toggle strong {
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Status Messages */
    .status {
      margin-top: 1rem;
      padding: 0.6rem 0.9rem;
      border-radius: var(--radius-sm);
      font-size: 0.85rem;
      font-weight: 500;
    }

    .status:empty {
      display: none;
    }

    .status.success {
      background: var(--accent-success-light);
      color: var(--accent-success);
    }

    .status.error {
      background: var(--accent-coral-light);
      color: var(--accent-coral);
    }

    .status.info {
      background: var(--accent-teal-light);
      color: var(--accent-teal);
    }

    /* Processing Section */
    .processing-section {
      background: var(--bg-section);
      border: 3px solid var(--border-soft);
      padding: 2.5rem;
      text-align: center;
    }

    .processing-section h2 {
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-primary);
      margin-bottom: 1.5rem;
    }

    /* Loading Bar (text-based + / -) */
    .loading-container {
      width: 100%;
      max-width: 500px;
      margin: 1.5rem auto;
      display: none;
      text-align: center;
    }

    .loading-text {
      font-family: "DM Sans", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      letter-spacing: 0.15em;
      font-size: 0.95rem;
    }

    .loading-text .plus {
      color: var(--accent-success);
    }

    .loading-text .minus {
      color: var(--accent-coral);
    }

    .processing-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    #viewResultsBtn {
      display: none;
    }

    /* Column sections spacing */
    .left-col,
    .right-col {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    /* Section Actions */
    .section-actions {
      margin-top: 1.25rem;
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .main-grid {
        grid-template-columns: 1fr;
      }

      .container {
        padding: 1.5rem;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- Header -->
    <header class="page-header">
      <h1>NeuGenes Platform</h1>
    </header>

    <!-- Main Two-Column Grid -->
    <div class="main-grid">
      <!-- LEFT COLUMN -->
      <div class="left-col">
        <!-- Image Upload -->
        <div class="section">
          <h2>Dataset Upload</h2>
          <div class="drop-zone" id="dropZone">
            <svg class="drop-zone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12" />
            </svg>
            <p><strong>Drop files here</strong> or click to browse</p>
            <p style="font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.7;">PNG, JPEG, TIFF supported</p>
          </div>
          <input type="file" id="fileInput" accept="image/png,image/jpeg,image/tiff" multiple style="display: none">
          <div class="file-list" id="fileList"></div>
          <div class="section-actions">
            <button class="btn btn-primary" id="uploadBtn" style="display: none;">Upload Files</button>
          </div>
          <p id="uploadStatus" class="status"></p>
        </div>

        <!-- Brain Structures -->
        <div class="section">
          <h2>Brain Structures</h2>
          <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">Click to expand regions and
            select structures for analysis.</p>
          <div class="tree-container">
            <div id="brainStructureTree"></div>
          </div>
          <p id="structureStatus" class="status"></p>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="right-col">
        <!-- Parameters -->
        <div class="section">
          <h2>Dataset Parameters</h2>
          <div class="params-grid">
            <div class="param-item full-width">
              <label for="experimentName">Experiment Name</label>
              <div class="param-desc">Name or identifier for this dataset</div>
              <input type="text" id="experimentName" placeholder="e.g. Npsr1 GFP Mouse 1 â€” July 30">
            </div>

            <div class="param-item full-width">
              <label>Analysis Mode</label>
              <div class="param-desc">Select the type of analysis to perform</div>
              <div class="radio-group">
                <label class="radio-option">
                  <input type="radio" name="analysisMode" id="dotCount" value="dotCount">
                  <span>Dot Count</span>
                </label>
                <label class="radio-option">
                  <input type="radio" name="analysisMode" id="expressionIntensity" value="expressionIntensity">
                  <span>Expression Intensity</span>
                </label>
              </div>
            </div>

            <div class="param-row">
              <div class="param-item">
                <label for="thresholdScale">Threshold Scale</label>
                <div class="param-desc">Sensitivity adjustment</div>
                <input type="number" step="0.1" id="thresholdScale" value="1.0">
              </div>
              <div class="param-item">
                <label for="layerInTiff">Layer in TIFF</label>
                <div class="param-desc">Target layer index</div>
                <input type="number" id="layerInTiff" value="1">
              </div>
            </div>

            <div class="param-row">
              <div class="param-item">
                <label for="patchSize">Patch Size</label>
                <div class="param-desc">Detection window size</div>
                <input type="number" id="patchSize" value="7">
              </div>
              <div class="param-item">
                <label for="ringWidth">Ring Width</label>
                <div class="param-desc">Surrounding region width</div>
                <input type="number" id="ringWidth" value="3">
              </div>
            </div>

            <div class="param-row">
              <div class="param-item">
                <label for="zThreshold">Z Threshold</label>
                <div class="param-desc">Statistical threshold</div>
                <input type="number" step="0.1" id="zThreshold" value="1.2">
              </div>
            </div>
          </div>
          <div class="section-actions">
            <button class="btn btn-secondary" id="saveParamsBtn">Save Parameters</button>
          </div>
          <p id="paramsStatus" class="status"></p>
        </div>
      </div>
    </div>

    <!-- Processing Section (Full Width Bottom) -->
    <div class="processing-section">
      <h2>Run Analysis</h2>
      <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Upload your dataset, configure parameters, then
        process.</p>

      <div class="loading-container" id="loadingContainer">
        <span id="loadingText" class="loading-text"></span>
      </div>

      <p id="processStatus" class="status"></p>

      <div class="processing-buttons">
        <button class="btn btn-primary btn-large" id="processBtn">Process Dataset</button>
        <button class="btn btn-primary btn-large" id="viewResultsBtn">View Results</button>
      </div>
    </div>
  </div>

  <script>
    // ===================== CONFIG =====================
    let MAX_SIZE_MB = 50;
    let MAX_FILES = 100;
    let DATASET_ID = null;
    let USERNAME = "test_user";
    let selectedFiles = [];

    async function loadConfig() {
      try {
        const res = await fetch('/config');
        const data = await res.json();
        MAX_SIZE_MB = data.MAX_SIZE_MB || MAX_SIZE_MB;
        MAX_FILES = data.MAX_FILES || MAX_FILES;
        console.log(`Config loaded: ${MAX_SIZE_MB} MB max, ${MAX_FILES} files max`);
      } catch (e) {
        console.log('Using default config');
      }
    }
    loadConfig();

    // ===================== DOM ELEMENTS =====================
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadStatus = document.getElementById('uploadStatus');
    const saveParamsBtn = document.getElementById('saveParamsBtn');
    const paramsStatus = document.getElementById('paramsStatus');
    const processBtn = document.getElementById('processBtn');
    const processStatus = document.getElementById('processStatus');
    //const loadingContainer = document.getElementById('loadingContainer');
    //const loadingBar = document.getElementById('loadingBar');
    const loadingContainer = document.getElementById('loadingContainer');
    const loadingText = document.getElementById('loadingText');
    const viewResultsBtn = document.getElementById('viewResultsBtn');

    // ===================== FILE UPLOAD LOGIC =====================
    dropZone.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', (e) => {
      addFiles(Array.from(e.target.files));
      fileInput.value = '';
    });

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      const files = filterFiles(Array.from(e.dataTransfer.files));
      if (files.length === 0) {
        showStatus(uploadStatus, 'No valid files detected. Use PNG, JPEG, or TIFF.', 'error');
        return;
      }
      addFiles(files);
    });

    function filterFiles(files) {
      const acceptedTypes = ['image/png', 'image/jpeg', 'image/tiff'];
      const acceptedExts = ['.png', '.jpg', '.jpeg', '.tiff', '.tif'];

      return files.filter(file => {
        const sizeMB = file.size / (1024 * 1024);
        if (sizeMB > MAX_SIZE_MB) {
          console.warn(`Skipping ${file.name}: too large`);
          return false;
        }
        const typeOk = acceptedTypes.includes(file.type.toLowerCase());
        const extOk = acceptedExts.some(ext => file.name.toLowerCase().endsWith(ext));
        if (!typeOk && !extOk) {
          console.warn(`Skipping ${file.name}: unsupported format`);
          return false;
        }
        return true;
      });
    }

    function addFiles(files) {
      if (!files || files.length === 0) {
        showStatus(uploadStatus, 'No files detected.', 'error');
        return;
      }

      const filtered = filterFiles(files);
      const remaining = MAX_FILES - selectedFiles.length;

      if (filtered.length > remaining) {
        showStatus(uploadStatus, `Only ${remaining} more file(s) allowed (limit: ${MAX_FILES}).`, 'error');
        return;
      }

      selectedFiles.push(...filtered);
      updateFileList();

      if (filtered.length > 0) {
        showStatus(uploadStatus, `${selectedFiles.length} file(s) ready for upload.`, 'info');
      }
    }

    function updateFileList() {
      if (selectedFiles.length === 0) {
        fileList.innerHTML = '';
        uploadBtn.style.display = 'none';
        return;
      }

      fileList.innerHTML = `<h3>${selectedFiles.length} file(s) selected</h3>`;
      selectedFiles.forEach((file, i) => {
        const item = document.createElement('div');
        item.className = 'file-item';
        item.innerHTML = `
          <span>${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
          <button class="remove-btn" onclick="removeFile(${i})">Remove</button>
        `;
        fileList.appendChild(item);
      });
      uploadBtn.style.display = 'inline-flex';
    }

    window.removeFile = function (index) {
      selectedFiles.splice(index, 1);
      updateFileList();
      if (selectedFiles.length === 0) {
        showStatus(uploadStatus, '', '');
      } else {
        showStatus(uploadStatus, `${selectedFiles.length} file(s) ready.`, 'info');
      }
    };

    uploadBtn.addEventListener('click', async () => {
      if (selectedFiles.length === 0) return;

      const formData = new FormData();
      selectedFiles.forEach(file => formData.append('files', file));

      if (DATASET_ID) {
        formData.append('datasetId', DATASET_ID);
      }
      formData.append('createdBy', USERNAME);

      uploadBtn.disabled = true;
      try {
        // ==================== CHECK FOR DUPLICATES FIRST ====================
        const checkRes = await fetch('/check_duplicate_images', {
          method: 'POST',
          body: formData
        });

        const checkData = await checkRes.json();
        const datasetName = checkData.existingDataset.parameters?.experiment_name || checkData.existingDataset.name || 'Unnamed Dataset';


        if (checkData.duplicatesFound) {
          const useExisting = confirm(
            `${checkData.matchCount} of ${checkData.totalUploaded} images already exist in dataset "${checkData.existingDataset.name}".\n\n` +
            `Status: ${checkData.existingDataset.status}\n` +
            `Images: ${checkData.existingDataset.imageCount}\n\n` +
            `Click OK to use the existing dataset, or Cancel to upload as new.`
          );

          if (useExisting) {
            DATASET_ID = checkData.existingDataset.id;
            showStatus(uploadStatus, `Using existing dataset: ${checkData.existingDataset.name}`, 'success');
            selectedFiles = [];
            updateFileList();
            uploadBtn.disabled = false;
            return;
          }
        }
      }
      catch (err) {
        console.log('error saving')
      }
      showStatus(uploadStatus, `Uploading ${selectedFiles.length} files...`, 'info');

      try {
        const res = await fetch('/upload_dataset', {
          method: 'POST',
          body: formData
        });
        const data = await res.json();

        if (data.success) {
          DATASET_ID = data.datasetId;
          showStatus(uploadStatus, `Uploaded ${data.filesUploaded} files successfully.`, 'success');
          selectedFiles = [];
          updateFileList();
        } else {
          showStatus(uploadStatus, `Error: ${data.error}`, 'error');
        }
      } catch (err) {
        showStatus(uploadStatus, `Upload failed: ${err.message}`, 'error');
      } finally {
        uploadBtn.disabled = false;
      }
    });

    // ===================== PARAMETERS =====================
    saveParamsBtn.addEventListener('click', async () => {
      const selectedAcronyms = getSelectedStructureAcronyms()

      const payload = {
        datasetId: DATASET_ID,
        experiment_name: document.getElementById('experimentName').value,
        structure_acronymns: selectedAcronyms.length > 0 ? selectedAcronyms : ['FULL_BRAIN'],
        dot_count: document.getElementById('dotCount').checked,
        expression_intensity: document.getElementById('expressionIntensity').checked,
        threshold_scale: parseFloat(document.getElementById('thresholdScale').value),
        layer_in_tiff: parseInt(document.getElementById('layerInTiff').value),
        patch_size: parseInt(document.getElementById('patchSize').value),
        ring_width: parseInt(document.getElementById('ringWidth').value),
        z_threshold: parseFloat(document.getElementById('zThreshold').value)
      };
      console.log('payload', payload)

      // send parameters in JSON body to backend
      const res = await fetch('/accept_dataset_parameters', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })

      // dispkay if parameter saving successful? 
      const data = await res.json()
      if (data.success) showStatus(paramsStatus, 'Parameters saved successfully.', 'success')
      else showStatus(paramsStatus, `Error saving parameters: ${data.error}`, 'error')
    })


    //==================== PROCESS FUNCTION ====================//

    async function pollUntilComplete(datasetId) {
      const POLL_INTERVAL = 2000

      while (true) {
        const response = await fetch(`/api/processing_status/${datasetId}`)
        const data = await response.json()

        if (data.status === 'completed') {
          return data
        }

        if (data.status === 'failed') {
          throw new Error(data.results?.error || 'Processing failed')
        }

        showStatus(processStatus, `Processing... (${data.status})`, 'info')

        await new Promise(r => setTimeout(r, POLL_INTERVAL))
      }
    }

    processBtn.addEventListener('click', async () => {
      if (!DATASET_ID) {
        showStatus(processStatus, 'Please upload a dataset first.', 'error')
        return
      }

      processBtn.disabled = true
      startLoadingAnimation()  // Use your text-based animation
      showStatus(processStatus, 'Processing...', 'info')

      try {
        // Start processing
        const res = await fetch('/process_dataset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ datasetId: DATASET_ID })
        })

        const data = await res.json()

        if (!data.success) {
          throw new Error(data.error)
        }

        showStatus(processStatus, 'Processing images...', 'info')

        // Poll until complete
        await pollUntilComplete(DATASET_ID)

        stopLoadingAnimation(true)
        showStatus(processStatus, 'Processing complete! Redirecting...', 'success')

        // Redirect to results page
        setTimeout(() => {
          window.location.href = `/results_page?datasetId=${DATASET_ID}`
        }, 1000)

      } catch (error) {
        stopLoadingAnimation(true)
        showStatus(processStatus, `Processing failed: ${error.message}`, 'error')
        processBtn.disabled = false
      }
    })

    //====================== RESULTS PAGE ======================//
    viewResultsBtn.addEventListener('click', () => {
      if (!DATASET_ID) {
        alert('Please upload and process a dataset first!');
        return;
      }
      window.location.href = `/results_page?datasetId=${DATASET_ID}`
      //window.location.href = '/results_page'
    })

    //==================== HELPER FUNCTIONS ====================//    
    function showStatus(element, message, type) {
      element.textContent = message
      element.className = 'status'
      if (type) element.classList.add(type)
    }

    function handleCheckbox(current, otherId) {
      if (current.checked) {
        document.getElementById(otherId).checked = false;
      }
    }
    /* ===================== BRAIN STRUCTURE TREE LOGIC ===================== */

    let expandedNodes = new Set();
    let selectedStructureIds = new Set();
    let brainTreeData = null;

    // Load the full structure hierarchy from JSON
    async function loadBrainStructures() {
      try {
        const res = await fetch("/structures.json");
        const data = await res.json();

        // Convert flat array into a nested tree
        brainTreeData = buildHierarchy(data);
        renderBrainTree();
      } catch (error) {
        console.error("Error loading structures.json:", error);
        document.getElementById("brainStructureTree").innerText =
          "Error loading brain structures.";
      }
    }

    // Build hierarchical tree from structure_id_path arrays
    function buildHierarchy(flatData) {
      const idToNode = {};
      let root = null;

      // First, create all nodes
      flatData.forEach((item) => {
        idToNode[item.id] = {
          id: item.id,
          name: item.name,
          acronym: item.acronym,
          checked: false,
          children: []
        };
      });

      // Then, link parents and children using structure_id_path
      flatData.forEach((item) => {
        const path = item.structure_id_path;
        if (path.length === 1) {
          root = idToNode[item.id];
        } else {
          const parentId = path[path.length - 2];
          if (idToNode[parentId]) {
            idToNode[parentId].children.push(idToNode[item.id]);
          }
        }
      });

      return root;
    }

    // Recursive node creation
    function createTreeNode(node) {
      const li = document.createElement("li");
      li.id = `node-${node.id}`;

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = node.checked;

      // Toggle selection, including nested children
      checkbox.addEventListener("change", () => {
        node.checked = checkbox.checked;
        toggleChildren(node, checkbox.checked);
        updateSelectedIds(node, checkbox.checked);
        renderBrainTree(); // re-render so descendants update visually
      });
      li.appendChild(checkbox);

      const label = document.createElement("span");
      label.className = "toggle";
      label.style.cursor = "pointer";
      label.innerHTML = `<strong>${node.name}</strong> (${node.acronym})`;

      label.addEventListener("click", () => {
        if (expandedNodes.has(node.id)) expandedNodes.delete(node.id);
        else expandedNodes.add(node.id);
        renderBrainTree();
      });

      li.appendChild(label);

      if (node.children && node.children.length > 0 && expandedNodes.has(node.id)) {
        const ul = document.createElement("ul");
        ul.style.paddingLeft = "20px";
        node.children.forEach((child) => {
          ul.appendChild(createTreeNode(child));
        });
        li.appendChild(ul);
      }

      return li;
    }

    // Recursive helper to toggle all children
    function toggleChildren(node, isChecked) {
      if (!node.children) return;
      node.children.forEach((child) => {
        child.checked = isChecked;
        toggleChildren(child, isChecked);
      });
    }

    // Recursive helper to update selected IDs
    function updateSelectedIds(node, isChecked) {
      if (isChecked) selectedStructureIds.add(node.id);
      else selectedStructureIds.delete(node.id);

      if (node.children) {
        node.children.forEach((child) => updateSelectedIds(child, isChecked));
      }
    }
    function getSelectedStructureAcronyms() {
      const acronyms = []
      function collectAcronyms(node) {
        if (node.checked) {
          acronyms.push(node.acronym)
        }
        if (node.children) {
          node.children.forEach(child => collectAcronyms(child))
        }
      }
      if (brainTreeData) {
        collectAcronyms(brainTreeData)
      }
      return acronyms
    }

    // Render the full tree
    function renderBrainTree() {
      const container = document.getElementById("brainStructureTree");
      container.innerHTML = "";
      if (!brainTreeData) return;
      const ul = document.createElement("ul");
      ul.appendChild(createTreeNode(brainTreeData));
      container.appendChild(ul);
    }

    // Helper for saving parameters
    function getSelectedStructureIds() {
      return Array.from(selectedStructureIds);
    }
    let loadingInterval = null;
    const TOTAL_SEGMENTS = 20; // total characters in the bar

    function renderLoadingBar(progressFraction) {
      const total = TOTAL_SEGMENTS;
      const filled = Math.round(total * progressFraction);
      let html = '';

      for (let i = 0; i < total; i++) {
        if (i < filled) {
          html += '<span class="plus">+</span>';
        } else {
          html += '<span class="minus">-</span>';
        }
      }
      loadingText.innerHTML = html;
    }

    function startLoadingAnimation() {
      loadingContainer.style.display = 'block';

      if (loadingInterval) clearInterval(loadingInterval);

      let current = 0;
      loadingInterval = setInterval(() => {
        current = (current + 1) % (TOTAL_SEGMENTS + 1);
        const fraction = current / TOTAL_SEGMENTS;
        renderLoadingBar(fraction);
      }, 150); // speed of animation (ms per step)
    }

    function stopLoadingAnimation(success) {
      if (loadingInterval) {
        clearInterval(loadingInterval);
        loadingInterval = null;
      }
      // all green pluses on success, all red dashes on failure
      renderLoadingBar(success ? 1 : 0);
    }

    // Initialize
    loadBrainStructures();
  </script>
</body>

</html>