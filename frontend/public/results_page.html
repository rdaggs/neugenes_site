<!-- result page-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Cal+Sans&display=swap" rel="stylesheet">

  <title>NeuGenes - Results</title>
  <style>
    body {
      background: #ffffff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", sans-serif;
      padding: 40px;
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      font-size: 2rem;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", sans-serif;
      font-weight: 500;
      text-align: center;
      line-height: 1.1;
      text-transform: uppercase;
      letter-spacing: -0.02rem;
      margin: 2rem 0 2rem;
      color: #075058;
    }

    h2 {
      font-size: 1.5rem;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", sans-serif;
      font-weight: 500;
      text-align: center;
      line-height: 1.1;
      letter-spacing: -0.02rem;
      color: #075058;
    }

    .back-button {
      margin-top: 1rem;
      padding: 0.5rem;
      background: #eafdff;
      border: 3px solid #bcfdff;
      color: #075058;
      font-weight: 600;
      text-transform: uppercase;
      border-radius: 5px;
      cursor: pointer;
    }

    .back-button:hover {
      background: #77d1db;
      border-color: #075058;
    }

    .content-wrapper {
      display: flex;
      gap: 20px;
      margin-top: 40px;
    }

    .image-column {
      flex: 2;
      background: #fffafd;
      padding: 20px;
      border: 3px solid #ffdaf2;
    }

    .params-column {
      flex: 1;
      background: #fffafd;
      padding: 20px;
      border: 3px solid #ffdaf2;
    }

    #resultImage {
      max-width: 100%;
      height: auto;
      border: 2px solid #ddd;
      display: block;
      margin: 20px auto 0;
    }

    .param-item {
      text-align: left;
      margin-bottom: 15px;
    }

    .param-item label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #075058;
    }

    input[type="text"],
    input[type="number"],
    select {
      border-radius: 0px;
      border: 2px solid #c392b2;
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
      font-family: inherit;
      font-size: 1rem;
      color: #333;
      background-color: #fff;
    }

    input[type="checkbox"] {
      margin-left: 0;
    }

    .reprocess-btn {
      margin-top: 1rem;
      padding: 0.75rem;
      background: #ffd1c3;
      border: 3px solid #e65428;
      color: #075058;
      font-weight: 600;
      text-transform: uppercase;
      border-radius: 5px;
      width: 100%;
      cursor: pointer;
    }

    .reprocess-btn:hover {
      background: #d3dd66;
      border-color: #075058;
    }

    .reprocess-btn:disabled {
      background: #ccc;
      border-color: #999;
      cursor: not-allowed;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      font-weight: bold;
      text-align: center;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .histogram-row {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 2rem;
    }

    .histogram-row img {
      width: 300px;       /* small square */
      height: 300px;
      object-fit: contain;
      border: 2px solid #ffdaf2;
      padding: 6px;
      border-radius: 4px;
      background: white;
    }
    select.param-input {
      border-radius: 0px;
      border: 2px solid #c392b2;
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
      background: white;
      font-family: inherit;
      font-size: 1rem;
      color: #333;
    }

    @media (max-width: 900px) {
      .content-wrapper {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>
  <button class="back-button" onclick="window.location.href='/'">‚Üê Back to Upload</button>

  <h1>Dataset Processing Results</h1>

  <div id="loadingMessage" class="loading">Loading results...</div>
  <div id="errorMessage" class="error" style="display: none;"></div>

  <div id="contentWrapper" class="content-wrapper" style="display: none;">
    <!-- Left Column: Image (2/3 width) -->
    <div class="image-column">
      <h2>Result Image</h2>
      <img id="resultImage" src="" alt="Processing result">
    </div>

    <!-- Right Column: Parameters (1/3 width) -->
    <div class="params-column">
      <h2>Parameters</h2>
      
      <!-- Histogram container -->
      <div class="histogram-row">
        
        <div class="histogram-box">
          <div class="hist-title">Raw Expression</div>
          <img src="/results/histogramRaw.png" alt="Histogram" id="histogramImage">
        </div>

        <div class="histogram-box">
          <div class="hist-title">Normalized Expression</div>
          <img src="/results/histogramNorm.png" alt="Histogram" id="histogramImage">
        </div>
      </div>

      <div class="param-item">
        <label for="removeTopN">Remove top N structures for coherence</label>
        <input type="number" step="1" id="removeTopN" value="0">
      </div>

      <div class="param-item">
        <label for="normalizationStrength">Normalization Strength</label>
        <input type="number" step = 0.1 id="normalizationStrength" value="0.0">
      </div>

      <div class="param-item">
      <label for="normType">Normalization Type</label>
      <select id="normType">
        <option value="none">None (Raw)</option>
        <option value="zscore">Z-score</option>
        <option value="minmax">Min-Max Scaling</option>
        <option value="robust">Robust Scaling</option>
      </select>
    </div>


      <button class="reprocess-btn" id="reprocessBtn">Reprocess</button>
      <p id="reprocessStatus" class="status"></p>
    </div>
  </div>

  <script>
    async function loadHeatmap() {
      try {
        console.log('fetching heatmap...')

        const response = await fetch('/api/result_heatmap')
        console.log('Response status:', response.status)

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`)
        }

        const data = await response.json()
        console.log('Received data:', data)

        if (!data.success) {
          showError(data.error || 'Failed to load results')
          return
        }

        // Hide loading, show content
        displayImage(data.heatMapPath)

      } catch (error) {
        console.error('Error loading results:', error)
        showError(`Failed to load results: ${error.message}`)
      }
    }

    async function loadHistograms() {
      try {
        console.log('fetching histograms...')

        // Fetch both histogram endpoints
        const res1 = await fetch('/api/histogram_raw')
        console.log('Histogram 1 response:', res1.status)

        if (!res1.ok) {
          throw new Error(`HTTP error on histogram 1! status: ${res1.status}`)
        }

        const res2 = await fetch('/api/histogram_norm')
        console.log('Histogram 2 response:', res2.status)

        if (!res2.ok) {
          throw new Error(`HTTP error on histogram 2! status: ${res2.status}`)
        }

        // Parse JSON
        const data1 = await res1.json()
        console.log('Histogram 1 data:', data1)

        if (!data1.success) {
          console.error('Error loading histogram 1:', data1.error)
          return
        }

        const data2 = await res2.json()
        console.log('Histogram 2 data:', data2)

        if (!data2.success) {
          console.error('Error loading histogram 2:', data2.error)
          return
        }

        // Insert images into DOM
        document.getElementById('hist1').src = data1.histogramPath
        document.getElementById('hist2').src = data2.histogramPath

        document.getElementById('hist1').style.display = 'block'
        document.getElementById('hist2').style.display = 'block'

      } catch (err) {
        console.error('Failed to load histograms:', err)
      }
    }

    function displayImage(imagePath) {
      console.log('Displaying image:', imagePath)
      document.getElementById('loadingMessage').style.display = 'none'
      document.getElementById('contentWrapper').style.display = 'flex'
      document.getElementById('resultImage').src = imagePath
    }

    function showError(message) {
      document.getElementById('loadingMessage').style.display = 'none'
      const errorDiv = document.getElementById('errorMessage')
      errorDiv.textContent = message
      errorDiv.style.display = 'block'
    }

    function showStatus(element, message, type) {
      element.textContent = message
      element.className = 'status'
      if (type) element.classList.add(type)
    }

    // Reprocess button handler
    document.getElementById('reprocessBtn').addEventListener('click', async () => {
      const reprocessBtn = document.getElementById('reprocessBtn')
      const reprocessStatus = document.getElementById('reprocessStatus')

      const payload = {
        remove_top_n: parseFloat(document.getElementById('removeTopN').value),
        normalizationStrength: parseInt(document.getElementById('normalizationStrength').value),
        patch_size: parseInt(document.getElementById('patchSize').value),
        ring_width: parseInt(document.getElementById('ringWidth').value),
        normType: parseFloat(document.getElementById('normType').value)
      }

      try {
        reprocessBtn.disabled = true
        showStatus(reprocessStatus, 'Saving parameters and reprocessing...', 'info')

        // Save parameters
        const saveRes = await fetch('/accept_dataset_parameters', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })

        const saveData = await saveRes.json()
        if (!saveData.success) {
          throw new Error(saveData.error || 'Failed to save parameters')
        }

        // Trigger reprocessing
        const processRes = await fetch('/process_dataset', { method: 'POST' })
        const processData = await processRes.json()

        if (processData.success) {
          showStatus(reprocessStatus, 'Reprocessing complete! Reloading...', 'success')

          // Reload the page to show new results
          setTimeout(() => {
            window.location.reload()
          }, 1500)
        } else {
          throw new Error(processData.error || 'Processing failed')
        }

      } catch (error) {
        showStatus(reprocessStatus, `Error: ${error.message}`, 'error')
        console.error('Reprocess error:', error)
      } finally {
        reprocessBtn.disabled = false
      }
    })
    function handleCheckbox(current, otherId) {
      if (current.checked) {
        document.getElementById(otherId).checked = false;
      }
    }

    // Load results when page loads
    loadHeatmap()
    loadHistogram()
  </script>
</body>

</html>